---
layout: post
title: 빌링키를 사용한 자동결제 방식 이해하기
tags:
  - [회사생활, 결제]
---

<br>

오늘 회사에서 일하면서 새롭게 배우게 된 내용이 있어 정리해보았다. 

우리팀에서 운영중인 서비스는 <b>정기 구독형 서비스</b>로 첫결제 시 등록된 카드로 매달 20~25일에 <b>자동결제(빌링)</b>가 실행된다. 나는 결제 파트 담당자는 아니어서 어떤식으로 자동결제(빌링)가 실행되는지 정확한 구조는 모르고 있었다. 그런데 오늘 정보보안팀으로부터 한가지 업무 요청을 받게되었다. 그 내용은 소비자가 우리 서비스를 처음 결제할 때 카드정보를 입력하는데, 이 정보가 DB에 저장되고 있는지, 저장되고 있다면 어떤 <b>암호화 알고리즘</b>을 사용하는지 확인해달라는 것이었다.  

처음 이 요청을 받았을 때는 나는 암호화된 카드정보가 데이터베이스 어딘가에 저장되어 있을것 이라고 예상했다. 그 이유는 매달 빌링이 실행될 때 사용자가 카드 정보를 다시 입력하지 않아도 자동으로 결제가 이루어지기 때문이었다. 그래서 소스를 분석하면서 관련 데이터들을 찾아보았다. 그런데 내 예상과 다르게 어떤 테이블에서도 카드관련 정보를 저장하고 있지 않았다. 그렇다면 매달 어떤 방식으로 자동결제가 진행되는 걸까?

정기결제 관련 소스들을 분석해보니, 정기결제 시 사용하는 어떤 암호화된 키값이 있다는 걸 알게되었다. 이 값은 소비자가 입력한 카드정보를 가지고 PG사에서 제공하는 빌링키 발급 API를 호출해서 리턴받는 값이었다. PG사로부터 응답받은 빌링키는 우리 회사의 데이터베이스에 보관하고 다음 정기결제 때 다시 사용하는 방식이었다. 바로 이 값을 <b>빌링키</b>라고 한다. 

우리 서비스의 PG사는 토스페이먼츠여서 토스에서 제공해주는 공식문서를 참고했다.

- [자동결제(빌링) 이해하기](https://docs.tosspayments.com/guides/billing/overview)

<br>

### 자동결제 과정

![자동결제과정](https://static.tosspayments.com/docs/billing-overview.png)

<br>

### 빌링키 발급과정

![빌링키 발급과정](https://static.tosspayments.com/docs/glossary/billing-key.png)

이미지출처 : [토스페이먼츠](https://docs.tosspayments.com/guides/billing/overview)
