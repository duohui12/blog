---
layout: post
title: (MSSQL) 그 Primary key가 정말 최선일까
tags:
  - [MSSQL,회사생활]
---

<br>

최근에 회사에서 회원의 독서활동을 관리하는 페이지를 개발한 적이 있다. 그 때 관련 테이블과 프로시저를 생성하고 DBA분께 검수를 받았었는데, PK 컬럼을 수정하는 게 좋을 것 같다는 의견을 주셨다😱😱😱 오늘은 그 내용을 정리해보려고 한다.

<br>

먼저 내가 설계한 테이블은 회원의 독서활동 이력을 저장하는 테이블이다. 따라서 

`(회원아이디, 회원이름, 회원이 읽은 책의 인덱스 값(책 테이블의 PK값), 한줄감상평, 등등 ...)` 과 같은 컬럼값을 가지고 있다. 그리고 나는 자동증가 컬럼값 Idx값을 만들어 PK로 잡으려고 했었다. 그런데 DBA분께서는 사용자 아이디값인 UserId 컬럼과 책인덱스값인 BookIdx 컬럼을 복합키로 잡는게 좋을 것 같다고 말씀하셨다. 

그 이유는 두가지였는데, 첫째는 `UserId컬럼과 BookIdx컬럼으로 select가 자주 일어나기 때문에 이 두 컬럼을 PK로 잡고 clustered index가 생성되는 것이 검색 성능면에서 유리하기 때문이었고`, 두번째 이유는 `한명의 사용자가 한권의 책에 대해 남길수 있는 감상평은 한개이기 때문에 UserId와 BookIdx를 PK로 잡으면 중복값이 들어오지 않도록 보장해 주기 때문이었다.`

<br>

하지만 난 여기서 두가지 의문이 들어 DBA분께 다시 질문을 했고 다음과 같은 답변을 받았다. 

먼저, 내가 만든 독서활동 테이블은 꽤 자주 insert 작업이 일어나는 테이블이다. 그런데 (UserId, BookIdx) 컬럼을 기준으로 clustered index가 생성되면 insert작업이 일어날 때마다 PK컬럼을 기준으로 정렬이 될텐데, 자동증가 컬럼값을 PK로 잡는데 정렬할때  성능면에서 더 유리하지 않을까라는 점이었다. 

=> DBA분께서는 insert를 할때마다 정렬이 되는게 맞다고 하셨다. 결국 <b>Trade-off </b> 라는 것이다. 보통은 SELECT와 DML(INSERT, UPDATE, DELETE) 중에서 SELECT를  더 중요하게 생각한다고 하셨다.

두번째, 2개의 복합 PK컬럼으로 clustered index가 생성되었다. 이럴 경우 인덱스를 생성할때 컬럼의 순서에 따라 데이터의 정렬 결과가 달라진다.  나의 경우는 어떤 순서로 기본키가 생성되는게 유리할 지 생각해보았다. 앞으로 내가 이 테이블을 가지고 구현할 부분은 UserId값을 가지고 그 사용자가 읽은 책에 관한 이력을 보여주는 페이지도 있고, BookIdx을 가지고 그 책을 읽은 사용자들을 보여주는 페이지도 존재할 것이다. 그렇다 보니 PK값으로 생성된 clustered index는 이 두가지 중 한가지 경우에서는 활용되지 못한다.

=> 위 두가지 예시 중 하나는 클러스터드 인덱스를 타지 못하는게 맞다. 하지만, 두가지 모두 SELECT 가 빈번하게 일어나기 때문에 복합키 기준으로 clustered index가 생성되게 하고, 나머지 한 경우는 non-clustered index를 만드는게 자동증가 컬럼을 PK로 잡고 두가지 경우 모두 non-clustered 인덱스로 만드는 것보다 유리하다고 하심. 

<br>
